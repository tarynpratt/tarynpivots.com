<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Testing Backups and Offloading CheckDB - Taryn Pratt - Pivots and other SQL fun</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Taryn" />
  <meta name="description" content="While every DBA knows they need to backup all their databases, not all may realize the importance of testing those backups. Performing backups is pointless, if you&amp;rsquo;re unable to restore them.
I wanted to restore our backups on a regular basis, so I set up a process to test them automatically, on a nightly basis.
Background Early on when I started working on the SQL Servers at Stack Overflow, we were taking daily backups." />

  <meta name="keywords" content="blog, sql, sql server, dba, database administrator, taryn, pivots, bluefeet, onlybluefeet, stack overflow, stackoverflow, code, stack, overflow, github, twitter, pivot" />






<meta name="generator" content="Hugo 0.86.1" />


<link rel="canonical" href="https://tarynpivots.com/post/2021/testing-backups-offload-dbcc-checkdb/" />



<link rel="icon" href="/favicon.ico" />










<link href="/dist/jane.min.css?v=2.7.0" rel="stylesheet">



<link rel="stylesheet" href="/css/custom.css">


<meta property="og:title" content="Testing Backups and Offloading CheckDB" />
<meta property="og:description" content="While every DBA knows they need to backup all their databases, not all may realize the importance of testing those backups. Performing backups is pointless, if you&rsquo;re unable to restore them.
I wanted to restore our backups on a regular basis, so I set up a process to test them automatically, on a nightly basis.
Background Early on when I started working on the SQL Servers at Stack Overflow, we were taking daily backups." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://tarynpivots.com/post/2021/testing-backups-offload-dbcc-checkdb/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-04-19T06:00:00+00:00" />
<meta property="article:modified_time" content="2021-04-19T06:00:00+00:00" />

<meta itemprop="name" content="Testing Backups and Offloading CheckDB">
<meta itemprop="description" content="While every DBA knows they need to backup all their databases, not all may realize the importance of testing those backups. Performing backups is pointless, if you&rsquo;re unable to restore them.
I wanted to restore our backups on a regular basis, so I set up a process to test them automatically, on a nightly basis.
Background Early on when I started working on the SQL Servers at Stack Overflow, we were taking daily backups."><meta itemprop="datePublished" content="2021-04-19T06:00:00+00:00" />
<meta itemprop="dateModified" content="2021-04-19T06:00:00+00:00" />
<meta itemprop="wordCount" content="2675">
<meta itemprop="keywords" content="sql,sql-server,stack-overflow,backup,restore,restore-testing,maintenance,checkdb,availability-group," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Testing Backups and Offloading CheckDB"/>
<meta name="twitter:description" content="While every DBA knows they need to backup all their databases, not all may realize the importance of testing those backups. Performing backups is pointless, if you&rsquo;re unable to restore them.
I wanted to restore our backups on a regular basis, so I set up a process to test them automatically, on a nightly basis.
Background Early on when I started working on the SQL Servers at Stack Overflow, we were taking daily backups."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-124638032-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Taryn Pratt</a>
    
    &mdash;
    <a href="/" class="logo-tagline">
       
         Pivots and other SQL fun
       
     </a>
     
</div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://tarynpivots.com/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://tarynpivots.com/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://tarynpivots.com/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://tarynpivots.com/post/about/">About</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <div class="logo">
    <a href="/" class="logo">
      
        Taryn Pratt
      
    </a>
  </div>

  
  <div class="logo-tagline">
    <a href="/" >
      
        Pivots and other SQL fun
      
    </a>
  </div>
  
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://tarynpivots.com/">Home</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://tarynpivots.com/post/">Archives</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://tarynpivots.com/tags/">Tags</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://tarynpivots.com/post/about/">About</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Testing Backups and Offloading CheckDB</h1>
      
      <div class="post-meta">
        <span class="post-time"> 2021-04-19 </span>
        
        <span class="more-meta"> 2675 words </span>
          <span class="more-meta"> 13 min read </span>

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#background">Background</a></li>
    <li><a href="#automating-the-testing">Automating the Testing</a>
      <ul>
        <li><a href="#maintaining-a-list-of-databases-to-test">Maintaining a List of Databases to Test</a></li>
        <li><a href="#restoring-database-backups">Restoring Database Backups</a></li>
        <li><a href="#running-dbcc-checkdb">Running DBCC CheckDB</a></li>
      </ul>
    </li>
    <li><a href="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>While every DBA knows they need to backup all their databases, not all may realize the importance of testing those backups. Performing backups is pointless, if you&rsquo;re unable to restore them.</p>
<p>I wanted to restore our backups on a regular basis, so I set up a process to test them automatically, on a nightly basis.</p>
<h2 id="background">Background</h2>
<p>Early on when I started working on the SQL Servers at Stack Overflow, we were taking daily backups. We had a handful of databases that were being restored for other processes, but the majority weren&rsquo;t actively tested to ensure the backups were good. Since you never want to be in a situation where you need to restore a database and find it doesn&rsquo;t work, my goal was to create a process to automatically restore our backups to a separate server, and then run <code>DBCC CHECKDB</code> on it.</p>
<p>Now, you might be wondering why I&rsquo;d run <code>CHECKDB</code> on the backup after I restore it and asking yourself &ldquo;aren&rsquo;t you supposed to run <code>CHECKDB</code> on the SQL Server you take a backup on?&rdquo;</p>
<p>Yes, technically many people suggest you do that, but we don&rsquo;t,  because while we take full backups on the primary replica in our <a href="https://docs.microsoft.com/en-us/sql/database-engine/availability-groups/windows/always-on-availability-groups-sql-server?view=sql-server-ver15">Always On Availability Groups</a>, we don&rsquo;t have maintenance windows, and running <code>CHECKDB</code> on a very busy production SQL Server like we have for Stack Overflow can cause issues (ask me how I know). We can&rsquo;t easily run a full <code>CHECKDB</code> in production, so since I was going to be restoring the backups to make sure they worked, I might as well run <code>CHECKDB </code>on it to verify everything.</p>
<h2 id="automating-the-testing">Automating the Testing</h2>
<p>Before I jumped into creating a new process there were some questions I needed to answer for this project:</p>
<ol>
<li>What databases do we want or need to test the backups for?</li>
<li>Where can we perform this testing? Do we have a server available for use?</li>
<li>How often do we want to test the backups? Nightly? Weekly? What would the cadence be for this process?</li>
</ol>
<p>The answer to the first question was pretty clear, since we can&rsquo;t easily run <code>DBCC CHECKDB</code> in production basically, any database that was in an Always On Availability Group was on the list to have the backup restored and tested.</p>
<p>Next, I needed a place to perform the testing. Thankfully, we had a separate server where we were already restoring some backups, so it was the perfect candidate for this. The only issue was lack of disk space for some of the large databases. We resolved the lack of space issue by purchasing a couple of new NVMEs which gave us a 14TB drive to use for the restores.</p>
<p>Lastly, it was figuring out how often we wanted to test our restores. Since we take full backups nightly, we decided we would restore all databases daily, then run <code>DBCC CHECKDB</code> against it. Is that a little much? Maybe, but it also gives us confidence that our backups are working.</p>
<p>Now that I had the answer to the questions above, it was time to create a process that would do the following:</p>
<ol>
<li>Automatically add or remove databases that need testing</li>
<li>Restore the our backups on a separate server</li>
<li>Run <a href="https://docs.microsoft.com/en-us/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql?redirectedfrom=MSDN&amp;view=sql-server-ver15"><code>DBCC CHECKDB</code></a> on the backup after being restored</li>
</ol>
<h3 id="maintaining-a-list-of-databases-to-test">Maintaining a List of Databases to Test</h3>
<p>I knew the initial list of databases we wanted to test, but what if that list changed? What would happen if we added new databases, or removed databases, and no longer had backups? I didn&rsquo;t want the nightly process to fail, and even though I typically know when we add or remove databases, I didn&rsquo;t want to hand-hold and edit the list manually, I wanted it to be dynamic.</p>
<p>To do this, I had to save the list of databases to restore. I did this by first creating a table in the <code>master</code> database on the server we were using for backup and restore testing. The table structure is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].</span><span class="n">DatabasesToRestore</span><span class="p">(</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">Id</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">Name</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">sysname</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">AvailabilityGroup</span><span class="p">]</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="n">IsActive</span><span class="w"> </span><span class="nb">bit</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">
</span><span class="w">	</span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="p">[</span><span class="n">PK_DatabasesToRestore</span><span class="p">]</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">CLUSTERED</span><span class="w"> </span><span class="p">([</span><span class="n">Id</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span><span class="w">
</span><span class="w"></span><span class="k">GO</span></code></pre></td></tr></table>
</div>
</div>
<p>This table stores basic information about each database, including name, but also the name of the <code>AvailabilityGroup</code> that the database is in. I purposely stored the AG name because of the way we save our backups. Our backup directory structure uses the Availability Group name instead of the name of the SQL Server in the file path because it allows the backup locations to stay consistent no matter what server is the primary. The file share for backups uses this directory structure:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">|--- server
    |--- Backups
        |--- SQL
            |--- AG-name1
                |--- Database1
                    --- database1_20210101.bak
                    --- database1_20210102.bak
                |--- Database2
                    --- database2_20210101.bak
            |--- AG-name2
                |--- Database1
                |--- Database2</code></pre></td></tr></table>
</div>
</div>
<p>By storing the name of the Availability Group for each database, it allowed me to dynamically create the path to the backup for testing. It also made the process to find additions and deletions for each availability group more efficient, so I didn&rsquo;t have to manually adjust the list of databases that would need nightly testing. All that was needed was the initial population of the databases to restore, and then the stored procedure would keep the list up to date. The stored procedure that I wrote is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">ALTER</span><span class="w"> </span><span class="k">Procedure</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">spUpdateDatabasesToRestore</span><span class="p">]</span><span class="w"> 
</span><span class="w"></span><span class="k">AS</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">  </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">fileSearch</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="o">@</span><span class="n">backupPath</span><span class="w"> </span><span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="o">@</span><span class="n">error</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">600</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">ag_name</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">ag_cursor</span><span class="w"> </span><span class="k">CURSOR</span><span class="w"> </span><span class="k">FOR</span><span class="w">
</span><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">AvailabilityGroup</span><span class="w">
</span><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">DatabasesToRestore</span><span class="w">
</span><span class="w">  </span><span class="k">OPEN</span><span class="w"> </span><span class="n">ag_cursor</span><span class="w">
</span><span class="w">  </span><span class="k">FETCH</span><span class="w"> </span><span class="k">NEXT</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">ag_cursor</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">@</span><span class="n">ag_name</span><span class="w">
</span><span class="w">  </span><span class="n">WHILE</span><span class="w"> </span><span class="o">@@</span><span class="n">FETCH_STATUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="w">  </span><span class="k">BEGIN</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="n">PRINT</span><span class="w"> </span><span class="s1">&#39;Getting databases for AG: &#39;</span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">ag_name</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="c1">-- go through the list of availability groups and their backup path
</span><span class="c1"></span><span class="w">	</span><span class="c1">-- update the list of databases to restore 
</span><span class="c1"></span><span class="w">	</span><span class="c1">-- adding new ones and deleting old ones that are no longer active databases
</span><span class="c1"></span><span class="w">
</span><span class="w">	</span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">backupPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="s1">&#39;\\fileserver\Backups\SQL\&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">ag_name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;\&#39;</span><span class="p">)</span><span class="w">
</span><span class="w">	</span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">fileSearch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;DIR /S /b/a-d/od/t:c &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">backupPath</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">files</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">IDENTITY</span><span class="p">,</span><span class="w"> </span><span class="n">FileName</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="k">max</span><span class="p">),</span><span class="w"> </span><span class="n">DBName</span><span class="w"> </span><span class="n">sysname</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="n">FileDate</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">@</span><span class="n">files</span><span class="w"> </span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span><span class="w">
</span><span class="w">	</span><span class="k">EXEC</span><span class="w"> </span><span class="n">master</span><span class="p">.</span><span class="n">sys</span><span class="p">.</span><span class="n">xp_cmdshell</span><span class="w"> </span><span class="o">@</span><span class="n">fileSearch</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="k">UPDATE</span><span class="w"> </span><span class="o">@</span><span class="n">files</span><span class="w"> 
</span><span class="w">	</span><span class="k">SET</span><span class="w"> </span><span class="n">DBName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">Left</span><span class="p">(</span><span class="k">replace</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">backupPath</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">charindex</span><span class="p">(</span><span class="s1">&#39;\&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">replace</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">backupPath</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="w">
</span><span class="w">	  </span><span class="n">FileDate</span><span class="w"> </span><span class="o">=</span><span class="w"> 
</span><span class="w">                </span><span class="k">cast</span><span class="p">(</span><span class="k">substring</span><span class="p">(</span><span class="k">right</span><span class="p">(</span><span class="k">replace</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">backuppath</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="k">replace</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">backuppath</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="w">
</span><span class="w">                </span><span class="o">-</span><span class="n">charindex</span><span class="p">(</span><span class="s1">&#39;\&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">replace</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">backuppath</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))),</span><span class="w"> 
</span><span class="w">                </span><span class="n">charindex</span><span class="p">(</span><span class="s1">&#39;_FULL_&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">right</span><span class="p">(</span><span class="k">replace</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">backuppath</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="w"> 
</span><span class="w">                </span><span class="n">len</span><span class="p">(</span><span class="k">replace</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">backuppath</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">-</span><span class="n">charindex</span><span class="p">(</span><span class="s1">&#39;\&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">replace</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">backuppath</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">date</span><span class="p">)</span><span class="w">
</span><span class="w">	</span><span class="k">WHERE</span><span class="w"> </span><span class="n">FileName</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%.bak%&#39;</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="n">PRINT</span><span class="w"> </span><span class="s1">&#39;inserting new databases for AG: &#39;</span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">ag_name</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="c1">-- Insert new databases into the Databases table 
</span><span class="c1"></span><span class="w">	</span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">DatabasesToRestore</span><span class="w"> </span><span class="p">(</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">AvailabilityGroup</span><span class="p">)</span><span class="w">
</span><span class="w">	</span><span class="k">SELECT</span><span class="w"> </span><span class="n">DBName</span><span class="p">,</span><span class="w"> </span><span class="n">AGName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">ag_name</span><span class="w">
</span><span class="w">	</span><span class="k">FROM</span><span class="w">
</span><span class="w">	</span><span class="p">(</span><span class="w">
</span><span class="w">		</span><span class="k">SELECT</span><span class="w"> </span><span class="n">DBName</span><span class="p">,</span><span class="w"> 
</span><span class="w">			</span><span class="n">rn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row_number</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">DBName</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">FileDate</span><span class="w"> </span><span class="k">desc</span><span class="p">)</span><span class="w">
</span><span class="w">		</span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">files</span><span class="w">
</span><span class="w">		</span><span class="k">WHERE</span><span class="w"> </span><span class="n">FileDate</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">()</span><span class="o">-</span><span class="mi">7</span><span class="w">
</span><span class="w">			</span><span class="k">AND</span><span class="w"> </span><span class="n">FileName</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%&#39;</span><span class="o">+@</span><span class="n">ag_name</span><span class="o">+</span><span class="s1">&#39;%&#39;</span><span class="w">
</span><span class="w">	</span><span class="p">)</span><span class="w"> </span><span class="n">f</span><span class="w">
</span><span class="w">	</span><span class="k">WHERE</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w">		</span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w">				</span><span class="k">FROM</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">DatabasesToRestore</span><span class="w"> </span><span class="n">d</span><span class="w">
</span><span class="w">				</span><span class="k">WHERE</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">DBName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">Name</span><span class="w">
</span><span class="w">				</span><span class="k">AND</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">AvailabilityGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">ag_name</span><span class="w">
</span><span class="w">    				</span><span class="k">AND</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">IsActive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="n">PRINT</span><span class="w"> </span><span class="s1">&#39;Removing any old databases for AG: &#39;</span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">ag_name</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="c1">-- mark any Databases that are no longer producing backups as IsActive = 0
</span><span class="c1"></span><span class="w">	</span><span class="k">UPDATE</span><span class="w"> </span><span class="n">d</span><span class="w">
</span><span class="w">	</span><span class="k">SET</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">IsActive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="w">	</span><span class="k">FROM</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">DatabasesToRestore</span><span class="w"> </span><span class="n">d</span><span class="w">
</span><span class="w">	</span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> 
</span><span class="w">	</span><span class="p">(</span><span class="w">
</span><span class="w">		</span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">DBName</span><span class="p">,</span><span class="w"> </span><span class="n">AGName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">ag_name</span><span class="w">
</span><span class="w">		</span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">files</span><span class="w"> 
</span><span class="w">		</span><span class="k">WHERE</span><span class="w"> </span><span class="n">FileDate</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">()</span><span class="o">-</span><span class="mi">7</span><span class="w">
</span><span class="w">			</span><span class="k">AND</span><span class="w"> </span><span class="n">DBName</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span><span class="w">			</span><span class="k">AND</span><span class="w"> </span><span class="n">FileName</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%&#39;</span><span class="o">+@</span><span class="n">ag_name</span><span class="o">+</span><span class="s1">&#39;%&#39;</span><span class="w">
</span><span class="w">	</span><span class="p">)</span><span class="w"> </span><span class="n">f</span><span class="w">
</span><span class="w">	    </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">DBName</span><span class="w">
</span><span class="w">	    </span><span class="k">AND</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">AvailabilityGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">AGName</span><span class="w">
</span><span class="w">	</span><span class="k">WHERE</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">IsActive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w">		</span><span class="k">AND</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">AvailabilityGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">ag_name</span><span class="w">
</span><span class="w">		</span><span class="k">AND</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">DBName</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="k">FETCH</span><span class="w"> </span><span class="k">NEXT</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">ag_cursor</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">@</span><span class="n">ag_name</span><span class="w">
</span><span class="w">  </span><span class="k">END</span><span class="w">
</span><span class="w">  </span><span class="k">CLOSE</span><span class="w"> </span><span class="n">ag_cursor</span><span class="w">  
</span><span class="w">  </span><span class="k">DEALLOCATE</span><span class="w"> </span><span class="n">ag_cursor</span><span class="w"> 
</span><span class="w"></span><span class="k">END</span></code></pre></td></tr></table>
</div>
</div>
<p>This procedure uses <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15">xp_cmdshell</a> to get the list of files in the backup directory, then adds new databases that are missing from the current list, and removes databases that haven&rsquo;t had a new .bak file in the last seven days. Finally, we have a scheduled job that executes this stored procedure nightly to keep the table of <code>DatabasesToRestore</code> up to date.</p>
<h3 id="restoring-database-backups">Restoring Database Backups</h3>
<p>Once I had a list of the databases to restore, and a way to maintain that list on its own, it was time to get the process in place to restore the backups for testing nightly.</p>
<p>In addition to restoring the backups, I also wanted to keep a record of what was being restored, as a reference, in the event there were issues or failures with the nightly job. To do this, I created another table which I put in the <code>master</code> database.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">DatabaseRestoreLog</span><span class="w">
</span><span class="w"></span><span class="p">(</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">DatabaseId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">RestoredName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">sysname</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">RestoredDate</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">date</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">RestoreStartTime</span><span class="p">]</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">RestoreEndTime</span><span class="p">]</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">DBCCStartTime</span><span class="p">]</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">DBCCEndTime</span><span class="p">]</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">PassedDBCCChecks</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bit</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w">
</span><span class="w">	</span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="p">[</span><span class="n">PK_DatabaseRestoreLog</span><span class="p">]</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">CLUSTERED</span><span class="w"> </span><span class="p">([</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span><span class="p">),</span><span class="w">
</span><span class="w">	</span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="p">[</span><span class="n">FK_DatabaseRestoreLog_DatabasesToRestore</span><span class="p">]</span><span class="w"> 
</span><span class="w">		</span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">([</span><span class="n">DatabaseId</span><span class="p">])</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">DatabasesToRestore</span><span class="w"> </span><span class="p">([</span><span class="n">Id</span><span class="p">])</span><span class="w">
</span><span class="w"></span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
<p>This table allows the job to capture critical details, like how long the restore took, it also tracked whether or not the backup passed the DBCC checks (more on that later).</p>
<p>As I mentioned earlier, we were restoring some databases in another process, so instead of inventing something from scratch, I decided to modify the existing stored procedure and expand it for the restore testing. Again, this procedure utilizes <code>xp_cmdshell</code> and loops through all of the databases in the <code>DatabasesToRestore</code> table and looks for the oldest databases that haven&rsquo;t been restored recently, creates the path to the backup, and then grabs the most recent .bak file to restore for testing.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">ALTER</span><span class="w"> </span><span class="k">Procedure</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">spBackupRestoreTesting</span><span class="w"> 
</span><span class="w">	</span><span class="o">@</span><span class="n">TimeLimit</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">43200</span><span class="p">,</span><span class="w">		</span><span class="c1">-- the amount of time we want to limit the restores - the default is 12 hours
</span><span class="c1"></span><span class="w">    </span><span class="o">@</span><span class="k">exec</span><span class="w"> </span><span class="nb">BIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="w"></span><span class="k">AS</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">	</span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">fileSearch</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="o">@</span><span class="n">backupFile</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span><span class="w">
</span><span class="w">		</span><span class="o">@</span><span class="n">data_dir</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;F:\DBRestore\&#39;</span><span class="p">,</span><span class="w"> 
</span><span class="w">		</span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">),</span><span class="w">
</span><span class="w">		</span><span class="o">@</span><span class="n">dropCmd</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span><span class="w">
</span><span class="w">		</span><span class="o">@</span><span class="n">RestoredDBName</span><span class="w"> </span><span class="n">sysname</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="o">@</span><span class="n">backupPath</span><span class="w"> </span><span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="o">@</span><span class="n">error</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">600</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="c1">-- Set the time we started the restore process so we know when we want to exit 
</span><span class="c1"></span><span class="w">	</span><span class="c1">-- if it hits the TimeLimit, we&#39;ll stop for the day
</span><span class="c1"></span><span class="w">	</span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">StartTime</span><span class="w"> </span><span class="n">datetime</span><span class="w">
</span><span class="w">	</span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">StartTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">()</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">fileList</span><span class="w"> </span><span class="k">Table</span><span class="w"> </span><span class="p">(</span><span class="n">rowNumber</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">identity</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">backupFile</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span><span class="w"> </span><span class="n">backupPath</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">));</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">FileListTable</span><span class="w"> </span><span class="k">Table</span><span class="w"> </span><span class="p">(</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">LogicalName</span><span class="p">]</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">PhysicalName</span><span class="p">]</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">260</span><span class="p">),</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="k">Type</span><span class="p">]</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="n">FileGroupName</span><span class="p">]</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="k">Size</span><span class="p">]</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">MaxSize</span><span class="p">]</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="n">FileId</span><span class="p">]</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="n">CreateLSN</span><span class="p">]</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="n">DropLSN</span><span class="p">]</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="n">UniqueId</span><span class="p">]</span><span class="w"> </span><span class="n">uniqueidentifier</span><span class="p">,</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="n">ReadOnlyLSN</span><span class="p">]</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="n">ReadWriteLSN</span><span class="p">]</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">BackupSizeInBytes</span><span class="p">]</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="n">SourceBlockSize</span><span class="p">]</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="n">FileGroupId</span><span class="p">]</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="n">LogGroupGUID</span><span class="p">]</span><span class="w"> </span><span class="n">uniqueidentifier</span><span class="p">,</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="n">DifferentialBaseLSN</span><span class="p">]</span><span class="w"> </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="n">DifferentialBaseGUID</span><span class="p">]</span><span class="w"> </span><span class="n">uniqueidentifier</span><span class="p">,</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="n">IsReadOnly</span><span class="p">]</span><span class="w"> </span><span class="nb">bit</span><span class="p">,</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="n">IsPresent</span><span class="p">]</span><span class="w"> </span><span class="nb">bit</span><span class="p">,</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="n">TDEThumbprint</span><span class="p">]</span><span class="w"> </span><span class="n">varbinary</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span><span class="w"> 
</span><span class="w">		</span><span class="p">[</span><span class="n">SnapshotUrl</span><span class="p">]</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">360</span><span class="p">));</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">database_id</span><span class="w"> </span><span class="nb">int</span><span class="w">
</span><span class="w">	</span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">database_name</span><span class="w"> </span><span class="n">sysname</span><span class="w">
</span><span class="w">	</span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">ag_name</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w">
</span><span class="w">	</span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">last_restore_date</span><span class="w"> </span><span class="nb">date</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="c1">-- loop through the list of databases
</span><span class="c1"></span><span class="w">	</span><span class="c1">-- restore them, then run DBCC checks on them
</span><span class="c1"></span><span class="w">	</span><span class="n">WHILE</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">DATEADD</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="o">@</span><span class="n">TimeLimit</span><span class="p">,</span><span class="o">@</span><span class="n">StartTime</span><span class="p">)</span><span class="w">
</span><span class="w">	</span><span class="k">BEGIN</span><span class="w">
</span><span class="w">		</span><span class="c1">-- grab the oldest databases that haven&#39;t been restored recently
</span><span class="c1"></span><span class="w">		</span><span class="k">SELECT</span><span class="w"> </span><span class="n">TOP</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">@</span><span class="n">database_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span><span class="w"> 
</span><span class="w">            </span><span class="o">@</span><span class="n">database_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span><span class="w"> 
</span><span class="w">            </span><span class="o">@</span><span class="n">ag_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">AvailabilityGroup</span><span class="p">,</span><span class="w"> 
</span><span class="w">            </span><span class="o">@</span><span class="n">last_restore_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">drl</span><span class="p">.</span><span class="n">LastRestoredDate</span><span class="w">
</span><span class="w">		</span><span class="k">FROM</span><span class="w"> </span><span class="n">DatabasesToRestore</span><span class="w"> </span><span class="n">d</span><span class="w">
</span><span class="w">		</span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w">
</span><span class="w">		</span><span class="p">(</span><span class="w">
</span><span class="w">			</span><span class="c1">-- get the last date each database was restored
</span><span class="c1"></span><span class="w">			</span><span class="k">SELECT</span><span class="w"> 
</span><span class="w">				</span><span class="n">DatabaseId</span><span class="p">,</span><span class="w">
</span><span class="w">				</span><span class="n">LastRestoredDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">RestoredDate</span><span class="p">)</span><span class="w">
</span><span class="w">			</span><span class="k">FROM</span><span class="w"> </span><span class="n">DatabaseRestoreLog</span><span class="w">
</span><span class="w">			</span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">DatabaseId</span><span class="w">
</span><span class="w">		</span><span class="p">)</span><span class="w"> </span><span class="n">drl</span><span class="w">
</span><span class="w">			</span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">Id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">drl</span><span class="p">.</span><span class="n">DatabaseId</span><span class="w">
</span><span class="w">		</span><span class="k">WHERE</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">IsActive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w">			</span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="n">drl</span><span class="p">.</span><span class="n">LastRestoredDate</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">GETDATE</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">DATE</span><span class="p">)</span><span class="w"> 
</span><span class="w">			    </span><span class="k">OR</span><span class="w"> </span><span class="n">drl</span><span class="p">.</span><span class="n">LastRestoredDate</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">)</span><span class="w">
</span><span class="w">		</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">drl</span><span class="p">.</span><span class="n">LastRestoredDate</span><span class="w"> 
</span><span class="w">
</span><span class="w">		</span><span class="k">IF</span><span class="w"> </span><span class="o">@@</span><span class="n">ROWCOUNT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="w">          </span><span class="k">BEGIN</span><span class="w">
</span><span class="w">            </span><span class="n">BREAK</span><span class="w">
</span><span class="w">          </span><span class="k">END</span><span class="w">
</span><span class="w">
</span><span class="w">		</span><span class="n">PRINT</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Restoring : &#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">database_name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; in AG &#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">ag_name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; last restored date: &#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">last_restore_date</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w">		</span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">backupPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;\\fileserver\Backups\SQL\&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">ag_name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;\&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">database_name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;\&#39;</span><span class="p">)</span><span class="w">
</span><span class="w">		</span><span class="n">PRINT</span><span class="w"> </span><span class="o">@</span><span class="n">backupPath</span><span class="w">
</span><span class="w">
</span><span class="w">		</span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">fileSearch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;DIR *.bak /b /O:D &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">backupPath</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">		</span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">@</span><span class="n">fileList</span><span class="p">(</span><span class="n">backupFile</span><span class="p">)</span><span class="w">
</span><span class="w">		</span><span class="k">EXEC</span><span class="w"> </span><span class="n">master</span><span class="p">.</span><span class="n">sys</span><span class="p">.</span><span class="n">xp_cmdshell</span><span class="w"> </span><span class="o">@</span><span class="n">fileSearch</span><span class="p">;</span><span class="w">
</span><span class="w">		</span><span class="k">UPDATE</span><span class="w"> </span><span class="o">@</span><span class="n">fileList</span><span class="w"> </span><span class="k">Set</span><span class="w"> </span><span class="n">backupPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">backupPath</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">		</span><span class="k">SELECT</span><span class="w"> </span><span class="n">Top</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">@</span><span class="n">backupFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">backupFile</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">backupPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">backupPath</span><span class="w">
</span><span class="w">		</span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">fileList</span><span class="w">
</span><span class="w">		</span><span class="k">WHERE</span><span class="w"> </span><span class="n">backupFile</span><span class="w"> </span><span class="k">Like</span><span class="w"> </span><span class="o">@</span><span class="n">database_name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;%&#39;</span><span class="w">
</span><span class="w">		</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">backupFile</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span><span class="w">
</span><span class="w">		</span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">backupFile</span><span class="w"> </span><span class="k">Is</span><span class="w"> </span><span class="k">Not</span><span class="w"> </span><span class="k">Null</span><span class="w">
</span><span class="w">			</span><span class="k">BEGIN</span><span class="w">
</span><span class="w">				</span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">fullPath</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">backupPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">backupFile</span><span class="p">;</span><span class="w">
</span><span class="w">				</span><span class="n">PRINT</span><span class="w"> </span><span class="s1">&#39;Backup File Found: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">fullPath</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">				</span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">@</span><span class="n">FileListTable</span><span class="w">
</span><span class="w">				</span><span class="k">EXEC</span><span class="p">(</span><span class="s1">&#39;Restore FileListOnly From Disk = &#39;&#39;&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">fullPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;&#39;&#39;&#39;</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">				</span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">RestoredDBName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">REPLACE</span><span class="p">(</span><span class="o">@</span><span class="n">backupFile</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;.bak&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w">				</span><span class="c1">-- insert into the log the Database we&#39;re restoring
</span><span class="c1"></span><span class="w">				</span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">dbo</span><span class="p">.[</span><span class="n">DatabaseRestoreLog</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">DatabaseId</span><span class="p">,</span><span class="w"> </span><span class="n">RestoredName</span><span class="p">,</span><span class="w"> </span><span class="n">RestoredDate</span><span class="p">,</span><span class="w"> </span><span class="n">RestoreStartTime</span><span class="p">)</span><span class="w">
</span><span class="w">				</span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">database_id</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">RestoredDBName</span><span class="p">,</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">(),</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">());</span><span class="w">
</span><span class="w">
</span><span class="w">				</span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Restore Database [&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">RestoredDBName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;] &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;  From Disk = &#39;&#39;&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">fullPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;&#39;&#39; With File = 1, &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span><span class="w">
</span><span class="w">				</span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;  Move N&#39;&#39;&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">LogicalName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;&#39;&#39; To N&#39;&#39;&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">data_dir</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">LogicalName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">RestoredDBName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="w">					</span><span class="n">REVERSE</span><span class="p">(</span><span class="k">SUBSTRING</span><span class="p">(</span><span class="n">REVERSE</span><span class="p">(</span><span class="n">PhysicalName</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">CHARINDEX</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">REVERSE</span><span class="p">(</span><span class="n">PhysicalName</span><span class="p">),</span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;&#39;&#39;, &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span><span class="w">
</span><span class="w">				</span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">FileListTable</span><span class="w">
</span><span class="w">
</span><span class="w">				</span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;  NoUnload, Stats = 5;&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span><span class="w">
</span><span class="w">				</span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;Alter Database [&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">RestoredDBName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;] Set Recovery Simple With No_Wait;&#39;</span><span class="w">
</span><span class="w">
</span><span class="w">				</span><span class="c1">-- if for some reason the database with the restored name exists, drop it first
</span><span class="c1"></span><span class="w">				</span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> 
</span><span class="w">							</span><span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">databases</span><span class="w"> 
</span><span class="w">							</span><span class="k">WHERE</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">RestoredDBName</span><span class="p">)</span><span class="w">
</span><span class="w">					</span><span class="k">BEGIN</span><span class="w">
</span><span class="w">						</span><span class="n">PRINT</span><span class="w"> </span><span class="s1">&#39;Dropping existing [&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">RestoredDBName</span><span class="w"> </span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">						</span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">dropCmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Alter Database [&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">RestoredDBName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;] Set Single_User With Rollback Immediate; Drop Database [&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">RestoredDBName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;];&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">						</span><span class="n">PRINT</span><span class="p">(</span><span class="o">@</span><span class="n">dropCmd</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">						</span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="k">exec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> 
</span><span class="w">							</span><span class="k">EXEC</span><span class="p">(</span><span class="o">@</span><span class="n">dropCmd</span><span class="p">);</span><span class="w">
</span><span class="w">					</span><span class="k">END</span><span class="w">
</span><span class="w">
</span><span class="w">				</span><span class="c1">-- if it doesn&#39;t exist, then restore the database
</span><span class="c1"></span><span class="w">				</span><span class="n">PRINT</span><span class="w"> </span><span class="s1">&#39;Restoring [&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">database_name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;] from &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">backupFile</span><span class="p">;</span><span class="w">
</span><span class="w">				</span><span class="n">PRINT</span><span class="p">(</span><span class="o">@</span><span class="n">cmd</span><span class="p">);</span><span class="w">
</span><span class="w">				</span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="k">exec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> 
</span><span class="w">					</span><span class="k">EXEC</span><span class="p">(</span><span class="o">@</span><span class="n">cmd</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">				</span><span class="c1">-- make sure the DB exists before trying to run DBCC CHECKDB on it
</span><span class="c1"></span><span class="w">				</span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">databases</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">RestoredDBName</span><span class="p">)</span><span class="w"> 
</span><span class="w">					</span><span class="k">BEGIN</span><span class="w">
</span><span class="w">						</span><span class="c1">-- When the restore is complete, update the Log to reflect the end time
</span><span class="c1"></span><span class="w">						</span><span class="k">UPDATE</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">DatabaseRestoreLog</span><span class="w">
</span><span class="w">						</span><span class="k">SET</span><span class="w"> </span><span class="n">RestoreEndTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">(),</span><span class="w">
</span><span class="w">							</span><span class="n">DBCCStartTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">()</span><span class="w">
</span><span class="w">						</span><span class="k">WHERE</span><span class="w"> </span><span class="n">DatabaseId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">database_id</span><span class="w">
</span><span class="w">							</span><span class="k">AND</span><span class="w"> </span><span class="n">RestoredName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">RestoredDBName</span><span class="w">
</span><span class="w">
</span><span class="w">						</span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">spRunDBCCChecks</span><span class="w"> </span><span class="o">@</span><span class="n">dbName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">RestoredDBName</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="k">exec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="k">exec</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">						</span><span class="c1">-- When the DBCC Check is complete, update the Log to reflect the end time
</span><span class="c1"></span><span class="w">						</span><span class="k">UPDATE</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">DatabaseRestoreLog</span><span class="w">
</span><span class="w">						</span><span class="k">SET</span><span class="w"> </span><span class="n">DBCCEndTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">()</span><span class="w">
</span><span class="w">						</span><span class="k">WHERE</span><span class="w"> </span><span class="n">DatabaseId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">database_id</span><span class="w">
</span><span class="w">							</span><span class="k">AND</span><span class="w"> </span><span class="n">RestoredName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">RestoredDBName</span><span class="w">
</span><span class="w">					</span><span class="k">END</span><span class="w">
</span><span class="w">				</span><span class="k">ELSE</span><span class="w"> 
</span><span class="w">					</span><span class="c1">-- if the restore failed, then raise an error that it failed and send an emails
</span><span class="c1"></span><span class="w">					</span><span class="k">BEGIN</span><span class="w">
</span><span class="w">						</span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Restore of database &#39;&#39;&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">RestoredDBName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;&#39;&#39; failed. Check the log on the server.&#39;</span><span class="w"> </span><span class="p">;</span><span class="w">
</span><span class="w">						</span><span class="c1">-- send an email alert to that the DBCC CHECKDB failed for the restored item
</span><span class="c1"></span><span class="w">						</span><span class="k">EXEC</span><span class="w"> </span><span class="n">msdb</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sp_send_dbmail</span><span class="w"> </span><span class="o">@</span><span class="n">profile_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Mail&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">recipients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;useyourown@email.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">error</span><span class="p">;</span><span class="w">
</span><span class="w">						</span><span class="n">RAISERROR</span><span class="p">(</span><span class="o">@</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">
</span><span class="w">					</span><span class="k">END</span><span class="w">
</span><span class="w">
</span><span class="w">			</span><span class="k">END</span><span class="w">
</span><span class="w">		</span><span class="k">ELSE</span><span class="w">
</span><span class="w">			</span><span class="k">BEGIN</span><span class="w">
</span><span class="w">				</span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;No Recent backup was found in &#39;&#39;&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">backupPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;&#39;&#39;&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">				</span><span class="n">RAISERROR</span><span class="p">(</span><span class="o">@</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">
</span><span class="w">			</span><span class="k">END</span><span class="w">
</span><span class="w">
</span><span class="w">		</span><span class="c1">-- delete the info on the one we just restored
</span><span class="c1"></span><span class="w">		</span><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">fileList</span><span class="w">
</span><span class="w">		</span><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">FileListTable</span><span class="w">
</span><span class="w">	</span><span class="k">END</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="c1">-- once we&#39;re done, let&#39;s clear out the DBCC_History_Log table a bit, cause it grows fast
</span><span class="c1"></span><span class="w">	</span><span class="k">DELETE</span><span class="w">
</span><span class="w">	</span><span class="k">FROM</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">DBCC_History_Log</span><span class="w">
</span><span class="w">	</span><span class="k">WHERE</span><span class="w"> </span><span class="n">DBCCCheckDate</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="c1">-- send an email to sql-alerts with a count of what was done and what passed
</span><span class="c1"></span><span class="w">	</span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">TotalDatabasesRestored</span><span class="w"> </span><span class="nb">int</span><span class="w"> 
</span><span class="w">	</span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">TotalPassedCheck</span><span class="w"> </span><span class="nb">int</span><span class="w"> 
</span><span class="w">
</span><span class="w">	</span><span class="k">SELECT</span><span class="w"> 
</span><span class="w">		</span><span class="o">@</span><span class="n">TotalDatabasesRestored</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w">
</span><span class="w">		</span><span class="o">@</span><span class="n">TotalPassedCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">PassedDBCCChecks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">DatabaseId</span><span class="w"> </span><span class="k">end</span><span class="p">)</span><span class="w">
</span><span class="w">	</span><span class="k">FROM</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">DatabaseRestoreLog</span><span class="w">
</span><span class="w">	</span><span class="k">WHERE</span><span class="w"> </span><span class="n">RestoredDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">GETDATE</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">date</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">subject</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Database restore results for &#39;</span><span class="p">,</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="n">getdate</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">date</span><span class="p">))</span><span class="w">
</span><span class="w">	</span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">body</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Total Databases Restored: &#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">TotalDatabasesRestored</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Total Databases Passing DBCC Check:&#39;</span><span class="p">,</span><span class="w">  </span><span class="o">@</span><span class="n">TotalPassedCheck</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="k">EXEC</span><span class="w"> </span><span class="n">msdb</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sp_send_dbmail</span><span class="w"> </span><span class="o">@</span><span class="n">profile_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Mail&#39;</span><span class="p">,</span><span class="w"> 
</span><span class="w">		</span><span class="o">@</span><span class="n">recipients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;useyourown@email.com&#39;</span><span class="p">,</span><span class="w"> 
</span><span class="w">		</span><span class="o">@</span><span class="n">subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">subject</span><span class="p">,</span><span class="w"> 
</span><span class="w">		</span><span class="o">@</span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">body</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">	
</span><span class="w"></span><span class="k">END</span></code></pre></td></tr></table>
</div>
</div>
<p>Once the database is restored we perform a <code>DBCC CHECKDB</code> on it to see if there are any issues.</p>
<p>Since we restore hundreds of databases daily, I set a limit on the amount of time we perform restore testing each day. We currently limit testing to 12 hours a day, but if  need be, we could easily adjust this to 18 hours or some other value. I attempted to make this process flexible to account for adding or removing  databases.</p>
<h3 id="running-dbcc-checkdb">Running DBCC CheckDB</h3>
<p>Outside of restoring our backups, the last piece is the most important&hellip;running a <code>CHECKDB</code> against the database since we do not do so in production.</p>
<p>If you look closely at the previous stored procedure, you won&rsquo;t see a direct call to <code>DBCC CHECKDB</code>. That&rsquo;s because I created a separate stored procedure to make that call. But before we get to that stored procedure, there is one more table that I created for this process. Unless you are actively watching the <code>CHECKDB</code> run, you&rsquo;re going to want to capture the results so you can see any issues that were found. In order to do this, I created one more table to capture the lengthy results:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">DBCC_History_Log</span><span class="w">
</span><span class="w"></span><span class="p">(</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">PK_DBCC_History_Log</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">DatabaseName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">sysname</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">DBCCCheckDate</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">date</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">Error</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="k">Level</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="k">State</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">MessageText</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">varchar</span><span class="p">](</span><span class="mi">7000</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">RepairLevel</span><span class="p">]</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">Status</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">DbId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">DbFragId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">ObjectId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">IndexId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">PartitionID</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">AllocUnitID</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">RidDbId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">RidPruId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">File</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">Page</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">Slot</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">RefDbId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">RefPruId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">RefFile</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">RefPage</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">RefSlot</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="n">Allocation</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">[</span><span class="k">TimeStamp</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="p">[</span><span class="n">DF_dbcc_history_TimeStamp</span><span class="p">]</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="p">(</span><span class="n">GETDATE</span><span class="p">())</span><span class="w">
</span><span class="w"></span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
<p>You might be wondering why I&rsquo;d want to save this info? Since this is a nightly process, I just want it to run in the background and only notify me if something is wrong in the <code>CHECKDB</code>. I also don&rsquo;t want to have to rerun <code>CHECKDB</code> if there’s an issue. Essentially, I only need to review the data in the table to see the error, and investigate from there.</p>
<p>This table contains the standard output from a <code>CHECKDB</code>, but also includes a few additional columns including the name of the database being tested and the date that the check was performed. The table is populated via the final stored procedure in this process:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">ALTER</span><span class="w"> </span><span class="k">Procedure</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">spRunDBCCChecks</span><span class="w">
</span><span class="w">    </span><span class="o">@</span><span class="n">dbName</span><span class="w"> </span><span class="n">sysname</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="o">@</span><span class="k">exec</span><span class="w"> </span><span class="nb">BIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> 
</span><span class="w"></span><span class="k">AS</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">	</span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">dropCmd</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span><span class="w">
</span><span class="w">			</span><span class="o">@</span><span class="n">error</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">600</span><span class="p">),</span><span class="w">
</span><span class="w">			</span><span class="o">@</span><span class="n">MailMsg</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="c1">-- DBCC CheckDB will output results that we want to capture to verify if there are errors
</span><span class="c1"></span><span class="w">	</span><span class="k">IF</span><span class="w"> </span><span class="n">OBJECT_ID</span><span class="p">(</span><span class="s1">&#39;tempdb..#tempdbcccheck&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span><span class="w">		</span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">#</span><span class="n">tempdbcccheck</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">#</span><span class="n">tempdbcccheck</span><span class="w">
</span><span class="w">	</span><span class="p">(</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">Error</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="k">Level</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="k">State</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">MessageText</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">varchar</span><span class="p">](</span><span class="mi">7000</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">RepairLevel</span><span class="p">]</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">Status</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">DbId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">DbFragId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">ObjectId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">IndexId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">PartitionID</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">AllocUnitID</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">RidDbId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">RidPruId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">File</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">Page</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">Slot</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">RefDbId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">RefPruId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">RefFile</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">RefPage</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">RefSlot</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="n">Allocation</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span><span class="w">	</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="n">PRINT</span><span class="w"> </span><span class="s1">&#39;Starting DBCC CHECKDB on &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">dbName</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">#</span><span class="n">tempdbcccheck</span><span class="w">
</span><span class="w">	</span><span class="k">EXEC</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;DBCC CHECKDB(&#39;&#39;&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">dbName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;&#39;&#39;) with tableresults&#39;</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="c1">-- insert the results in the history log table
</span><span class="c1"></span><span class="w">	</span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">DBCC_History_Log</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">DatabaseName</span><span class="p">,</span><span class="w"> </span><span class="n">DBCCCheckDate</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">Level</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="k">State</span><span class="p">],</span><span class="w"> </span><span class="n">MessageText</span><span class="p">,</span><span class="w"> </span><span class="n">RepairLevel</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">Status</span><span class="p">],</span><span class="w"> </span><span class="n">DbId</span><span class="p">,</span><span class="w"> </span><span class="n">DbFragId</span><span class="p">,</span><span class="w"> 
</span><span class="w">		</span><span class="n">ObjectId</span><span class="p">,</span><span class="w"> </span><span class="n">IndexId</span><span class="p">,</span><span class="w"> </span><span class="n">PartitionID</span><span class="p">,</span><span class="w"> </span><span class="n">AllocUnitID</span><span class="p">,</span><span class="w"> </span><span class="n">RidDbId</span><span class="p">,</span><span class="w"> </span><span class="n">RidPruId</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">File</span><span class="p">],</span><span class="w"> </span><span class="n">Page</span><span class="p">,</span><span class="w"> </span><span class="n">Slot</span><span class="p">,</span><span class="w"> </span><span class="n">RefDbId</span><span class="p">,</span><span class="w"> </span><span class="n">RefPruId</span><span class="p">,</span><span class="w"> </span><span class="n">RefFile</span><span class="p">,</span><span class="w"> </span><span class="n">RefPage</span><span class="p">,</span><span class="w"> </span><span class="n">RefSlot</span><span class="p">,</span><span class="w"> </span><span class="n">Allocation</span><span class="p">)</span><span class="w">
</span><span class="w">	</span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">dbName</span><span class="p">,</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">(),</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="o">*</span><span class="w">
</span><span class="w">	</span><span class="k">FROM</span><span class="w"> </span><span class="o">#</span><span class="n">tempdbcccheck</span><span class="w"> </span><span class="n">t</span><span class="w">
</span><span class="w">
</span><span class="w">	</span><span class="c1">-- if the there were no errors in the database check, then we can safely drop the DB
</span><span class="c1"></span><span class="w">	</span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> 
</span><span class="w">					</span><span class="k">FROM</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">DBCC_History_Log</span><span class="w">
</span><span class="w">					</span><span class="k">WHERE</span><span class="w"> </span><span class="n">DatabaseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">dbName</span><span class="w">
</span><span class="w">						</span><span class="k">AND</span><span class="w"> </span><span class="n">DBCCCheckDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="n">getdate</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">date</span><span class="p">)</span><span class="w">
</span><span class="w">						</span><span class="k">AND</span><span class="w"> </span><span class="p">[</span><span class="k">Level</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">)</span><span class="w">
</span><span class="w">		</span><span class="k">BEGIN</span><span class="w">
</span><span class="w">			</span><span class="k">UPDATE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">DatabaseRestoreLog</span><span class="p">]</span><span class="w">
</span><span class="w">			</span><span class="k">SET</span><span class="w"> </span><span class="p">[</span><span class="n">PassedDBCCChecks</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w">			</span><span class="k">WHERE</span><span class="w"> </span><span class="p">[</span><span class="n">RestoredName</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">dbName</span><span class="w">
</span><span class="w">				</span><span class="k">AND</span><span class="w"> </span><span class="p">[</span><span class="n">RestoredDate</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="n">getdate</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">date</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w">			</span><span class="n">PRINT</span><span class="w"> </span><span class="s1">&#39;Clean DBCCCheck - dropping database [&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">dbName</span><span class="w"> </span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">			</span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">dropCmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Alter Database [&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">dbName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;] Set Single_User With Rollback Immediate; Drop Database [&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">dbName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;];&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">			</span><span class="n">PRINT</span><span class="p">(</span><span class="o">@</span><span class="n">dropCmd</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">			</span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="k">exec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> 
</span><span class="w">			</span><span class="k">BEGIN</span><span class="w">
</span><span class="w">				</span><span class="k">EXEC</span><span class="p">(</span><span class="o">@</span><span class="n">dropCmd</span><span class="p">);</span><span class="w">
</span><span class="w">			</span><span class="k">END</span><span class="w">
</span><span class="w">		</span><span class="k">END</span><span class="w">
</span><span class="w">	</span><span class="k">ELSE</span><span class="w">
</span><span class="w">		</span><span class="k">BEGIN</span><span class="w">
</span><span class="w">			</span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;DBCC CHECKDB generated errors for database &#39;&#39;&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">dbName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;&#39;&#39; not dropping for further review.&#39;</span><span class="w"> </span><span class="p">;</span><span class="w">
</span><span class="w">			</span><span class="c1">-- send an email alert to sql-alerts that the DBCC CHECKDB failed for the restored item
</span><span class="c1"></span><span class="w">			</span><span class="k">EXEC</span><span class="w"> </span><span class="n">msdb</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sp_send_dbmail</span><span class="w"> </span><span class="o">@</span><span class="n">profile_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Mail&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">recipients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;useyourown@email.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">error</span><span class="p">;</span><span class="w">
</span><span class="w">			</span><span class="n">RAISERROR</span><span class="p">(</span><span class="o">@</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">
</span><span class="w">		</span><span class="k">END</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">END</span></code></pre></td></tr></table>
</div>
</div>
<p>In this stored procedure I do a couple of things, run <code>CHECKDB</code> and then validate that the <code>CHECKDB</code> was successful. If it wasn&rsquo;t successful, then we don&rsquo;t drop the database, and we send an email alert stating that something needs to be investigated. If everything is ok with the <code>CHECKDB</code>, then we drop the database and it will either move to the next database to restore, or it will exit the job if we have hit the 12 hour time limit.</p>
<p>To get this entire process done, I have two SQL Agent jobs running - one to update the list of the <code>DatabasesToRestore</code> via <code>spUpdateDatabasesToRestore</code> and one that executes the Backup and Restore Testing procedure (<code>spBackupRestoreTesting</code>).</p>
<p>I&rsquo;ve added all these scripts to <a href="https://github.com/tarynpratt/misc_sql_scripts/tree/master/BackupRestoreTesting">GitHub</a>, feel free to peruse them that way or tell me how terrible they are.</p>
<h2 id="final-thoughts">Final Thoughts</h2>
<p>Currently, we&rsquo;re restoring 398 databases daily and running the <code>DBCC CHECKDB</code> on each one of them. Does that seem like a lot? Probably, but this process has, in fact, caught issues with some of our databases.</p>
<p>If the <code>CHECKDB</code> finds an issue, it doesn&rsquo;t drop the database (leaving it for investigation), it sends an email alert. This gives me ample time to figure out what has gone wrong and fix the issue on the production database.</p>
<p>Will this capture issues on the production server that don&rsquo;t exist in the backup? No, but it does give us confidence in our backups, and has found issues with databases that needed to be fixed - like data corruption. Ideally, you&rsquo;d be able to run <code>CHECKDB</code> in production, but when you can&rsquo;t, you need to get creative. This process does two things - tests our backups daily to ensure they’re working, and runs the <code>CHECKDB</code> to make sure there is no corruption in the backup (which would bite us if we ever needed a backup).</p>
<p>How do you run <code>CHECKDB</code>? Do you run it on your production servers or do you run it on a separate server?</p>

    </div>

    
    

    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://tarynpivots.com/tags/sql/">sql</a>
          <a href="https://tarynpivots.com/tags/sql-server/">sql-server</a>
          <a href="https://tarynpivots.com/tags/stack-overflow/">stack-overflow</a>
          <a href="https://tarynpivots.com/tags/backup/">backup</a>
          <a href="https://tarynpivots.com/tags/restore/">restore</a>
          <a href="https://tarynpivots.com/tags/restore-testing/">restore-testing</a>
          <a href="https://tarynpivots.com/tags/maintenance/">maintenance</a>
          <a href="https://tarynpivots.com/tags/checkdb/">checkdb</a>
          <a href="https://tarynpivots.com/tags/availability-group/">availability-group</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/2021/t-sql-tuesday-141-work-life-balance/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">T-SQL Tuesday #141 - Work/Life Balance</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/2021/fighting-with-deadlocks/">
            <span class="next-text nav-default">Fighting with Deadlocks</span>
            <span class="prev-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  

  <div id="disqus_thread"  class="disqus-comment"></div>
  <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'tarynpivots-com';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

    })();
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://stackoverflow.com/users/426671/taryn" rel="me noopener" class="iconfont icon-stack-overflow"
        title="stack-overflow" target="_blank">
      </a>
      <a href="https://twitter.com/tarynpivots" rel="me noopener" class="iconfont icon-twitter"
        title="twitter" target="_blank">
      </a>
      <a href="https://github.com/tarynpratt" rel="me noopener" class="iconfont icon-github"
        title="github" target="_blank">
      </a>
  <a href="https://tarynpivots.com/index.xml" rel="noopener alternate" type="application/rss&#43;xml" class="iconfont icon-rss"
    title="rss" target="_blank">
  </a>
  </div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2013 -
    2021
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span><span class="author">
        Taryn
        
      </span></span>

  
  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
<script type="text/javascript" src="/dist/jane.min.js?v=2.7.0"></script>





  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  








</body>
</html>
